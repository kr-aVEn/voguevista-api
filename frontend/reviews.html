<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VogueVista â€” Reviews</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body { font-family: Arial, sans-serif; background: #f5f5f5; }

        /* â”€â”€ Layout â”€â”€ */
        .container { display: flex; height: 100vh; }

        /* â”€â”€ Sidebar â”€â”€ */
        .sidebar {
            width: 20%;
            background-color: #a52a2a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .welcome {
            margin-bottom: 20px;
            font-size: 16px;
            text-align: center;
            padding: 14px;
            background-color: #8b4513;
            border-radius: 5px;
            width: 100%;
        }

        .nav-item {
            display: block;
            padding: 15px;
            background-color: #8b4513;
            color: white;
            text-align: center;
            margin-bottom: 10px;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            border: none;
            font-family: Arial, sans-serif;
            transition: background-color 0.2s;
        }

        .nav-item:hover { background-color: #6b3a0d; }
        .nav-item.active { background-color: #6b3a0d; border-left: 4px solid #b0e0e6; }

        /* â”€â”€ Main â”€â”€ */
        .main-content { width: 80%; display: flex; flex-direction: column; }

        .header {
            background-color: #b0e0e6;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            border-bottom: 2px solid #a52a2a;
            color: #333;
        }

        .content { padding: 24px; overflow-y: auto; height: calc(100vh - 72px); }

        /* â”€â”€ Two column layout â”€â”€ */
        .two-col { display: flex; gap: 24px; flex-wrap: wrap; }

        /* â”€â”€ Write Review Box â”€â”€ */
        .review-form-box {
            background: white;
            border-radius: 8px;
            border-top: 4px solid #a52a2a;
            padding: 24px;
            flex: 1;
            min-width: 280px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            height: fit-content;
        }

        .review-form-box h2 {
            color: #a52a2a;
            margin-bottom: 20px;
            font-size: 18px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .form-group { margin-bottom: 16px; }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: bold;
            color: #555;
            margin-bottom: 6px;
        }

        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 11px 14px;
            border: 1.5px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            font-family: Arial, sans-serif;
            outline: none;
            transition: border-color 0.2s;
            background: white;
        }

        .form-group select:focus,
        .form-group textarea:focus { border-color: #a52a2a; }

        .form-group textarea { resize: vertical; min-height: 100px; }

        /* â”€â”€ Star Rating â”€â”€ */
        .star-group { margin-bottom: 16px; }

        .star-group label {
            display: block;
            font-size: 13px;
            font-weight: bold;
            color: #555;
            margin-bottom: 8px;
        }

        .stars {
            display: flex;
            gap: 6px;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }

        .stars input { display: none; }

        .stars label {
            font-size: 32px;
            color: #ddd;
            cursor: pointer;
            transition: color 0.15s;
            margin: 0;
        }

        .stars input:checked ~ label,
        .stars label:hover,
        .stars label:hover ~ label {
            color: #ffc107;
        }

        .rating-text {
            font-size: 13px;
            color: #888;
            margin-top: 6px;
        }

        /* â”€â”€ Submit Button â”€â”€ */
        .btn-submit {
            width: 100%;
            padding: 13px;
            background-color: #a52a2a;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            font-family: Arial, sans-serif;
            transition: background-color 0.2s;
        }

        .btn-submit:hover { background-color: #8b4513; }
        .btn-submit:disabled { background-color: #ccc; cursor: not-allowed; }

        /* â”€â”€ Messages â”€â”€ */
        .message {
            display: none;
            padding: 12px 14px;
            border-radius: 5px;
            font-size: 13px;
            margin-bottom: 16px;
            text-align: center;
        }
        .message.success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; display: block; }
        .message.error   { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; display: block; }
        .message.loading { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; display: block; }

        /* â”€â”€ Reviews List Box â”€â”€ */
        .reviews-list-box {
            background: white;
            border-radius: 8px;
            border-top: 4px solid #a52a2a;
            padding: 24px;
            flex: 1.4;
            min-width: 300px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .reviews-list-box h2 {
            color: #a52a2a;
            margin-bottom: 16px;
            font-size: 18px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Filter bar */
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-bar select {
            padding: 8px 12px;
            border: 1.5px solid #e0e0e0;
            border-radius: 5px;
            font-size: 13px;
            font-family: Arial, sans-serif;
            outline: none;
            flex: 1;
        }

        .filter-bar select:focus { border-color: #a52a2a; }

        .refresh-btn {
            background: none;
            border: 1px solid #a52a2a;
            color: #a52a2a;
            padding: 6px 14px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            font-family: Arial, sans-serif;
            white-space: nowrap;
        }

        .refresh-btn:hover { background: #a52a2a; color: white; }

        /* Review card */
        .review-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            transition: box-shadow 0.2s;
        }

        .review-card:hover { box-shadow: 0 2px 12px rgba(165,42,42,0.1); }

        .review-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .review-pkg {
            font-weight: bold;
            color: #a52a2a;
            font-size: 14px;
        }

        .review-user {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }

        /* Star display */
        .star-display { color: #ffc107; font-size: 18px; letter-spacing: 2px; }
        .star-display .empty { color: #ddd; }

        .review-text {
            font-size: 14px;
            color: #444;
            line-height: 1.6;
            margin-top: 8px;
            font-style: italic;
        }

        .review-text::before { content: '"'; color: #a52a2a; font-size: 18px; }
        .review-text::after  { content: '"'; color: #a52a2a; font-size: 18px; }

        .delete-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: 1px solid #dc3545;
            color: #dc3545;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            font-family: Arial, sans-serif;
        }

        .delete-btn:hover { background: #dc3545; color: white; }

        /* Summary bar */
        .summary-bar {
            background: #fff8f8;
            border: 1px solid #e0c0c0;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            gap: 24px;
            font-size: 13px;
            flex-wrap: wrap;
        }

        .summary-bar .s-item { color: #555; }
        .summary-bar .s-item span { font-weight: bold; color: #a52a2a; }

        /* Empty / loading */
        .state-msg { text-align: center; padding: 30px; color: #888; font-size: 14px; }
        .state-msg .icon { font-size: 36px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="welcome">ğŸ‘¤ <span id="sidebar-username">User</span></div>
        <nav style="width:100%">
            <a class="nav-item" href="dashboard.html">ğŸ  Dashboard</a>
            <a class="nav-item" href="map.html">ğŸŒ Live Map</a>
            <a class="nav-item" href="bookings.html">ğŸ“… Bookings</a>
            <a class="nav-item active">â­ Reviews</a>
            <a class="nav-item" onclick="logout()"
               style="margin-top:auto; background:#6b3a0d;">ğŸšª Log Out</a>
        </nav>
    </aside>

    <!-- Main -->
    <main class="main-content">
        <div class="header">â­ Reviews</div>
        <div class="content">
            <div class="two-col">

                <!-- â”€â”€ Write a Review â”€â”€ -->
                <div class="review-form-box">
                    <h2>âœï¸ Write a Review</h2>

                    <div class="message" id="review-msg"></div>

                    <div class="form-group">
                        <label>Select Package</label>
                        <select id="pkg-select">
                            <option value="">-- Choose a package --</option>
                        </select>
                    </div>

                    <!-- Star Rating Input -->
                    <div class="star-group">
                        <label>Your Rating</label>
                        <div class="stars">
                            <input type="radio" id="s5" name="rating" value="5"/>
                            <label for="s5">â˜…</label>
                            <input type="radio" id="s4" name="rating" value="4"/>
                            <label for="s4">â˜…</label>
                            <input type="radio" id="s3" name="rating" value="3"/>
                            <label for="s3">â˜…</label>
                            <input type="radio" id="s2" name="rating" value="2"/>
                            <label for="s2">â˜…</label>
                            <input type="radio" id="s1" name="rating" value="1"/>
                            <label for="s1">â˜…</label>
                        </div>
                        <div class="rating-text" id="rating-text">Click a star to rate</div>
                    </div>

                    <div class="form-group">
                        <label>Your Review</label>
                        <textarea id="review-text"
                            placeholder="Share your experience â€” what did you love? What could be better?">
                        </textarea>
                    </div>

                    <button class="btn-submit" id="submit-btn" onclick="submitReview()">
                        â­ Submit Review
                    </button>
                </div>

                <!-- â”€â”€ Reviews List â”€â”€ -->
                <div class="reviews-list-box">
                    <h2>
                        All Reviews
                        <button class="refresh-btn" onclick="loadReviews()">â†» Refresh</button>
                    </h2>

                    <!-- Filter -->
                    <div class="filter-bar">
                        <select id="filter-pkg" onchange="loadReviews()">
                            <option value="">All Packages</option>
                        </select>
                    </div>

                    <!-- Summary -->
                    <div class="summary-bar" id="summary-bar" style="display:none">
                        <div class="s-item">Total: <span id="sum-total">0</span> reviews</div>
                        <div class="s-item">Avg Rating: <span id="sum-avg">â€“</span> â­</div>
                        <div class="s-item">5â˜…: <span id="sum-5">0</span></div>
                        <div class="s-item">4â˜…: <span id="sum-4">0</span></div>
                        <div class="s-item">3â˜…: <span id="sum-3">0</span></div>
                    </div>

                    <!-- List -->
                    <div id="reviews-list">
                        <div class="state-msg">
                            <div class="icon">â­</div>
                            <p>Loading reviews...</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>
</div>

<script>
    const API = 'http://localhost:8080/api';
    let packages  = [];
    let allReviews = [];
    
const currentUserId = parseInt(localStorage.getItem('vv_userId')) || null;

    // â”€â”€ Star rating labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ratingLabels = {
        1: 'â­ Poor',
        2: 'â­â­ Fair',
        3: 'â­â­â­ Good',
        4: 'â­â­â­â­ Very Good',
        5: 'â­â­â­â­â­ Excellent!'
    };

    // â”€â”€ On Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.onload = function () {
        const username = localStorage.getItem('vv_user');
        if (!username) { window.location.href = 'login.html'; return; }
        document.getElementById('sidebar-username').textContent = username;

        // Star rating live label
        document.querySelectorAll('.stars input').forEach(input => {
            input.addEventListener('change', () => {
                document.getElementById('rating-text').textContent =
                    ratingLabels[input.value] || 'Click a star to rate';
            });
        });

        loadPackages();
        loadReviews();
    };

    // â”€â”€ Load packages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function loadPackages() {
        fetch(`${API}/packages`)
            .then(r => r.json())
            .then(pkgs => {
                packages = pkgs;

                const sel      = document.getElementById('pkg-select');
                const filterSel = document.getElementById('filter-pkg');

                pkgs.forEach(pkg => {
                    // form dropdown
                    const o1 = document.createElement('option');
                    o1.value = pkg.id;
                    o1.textContent = pkg.name;
                    sel.appendChild(o1);

                    // filter dropdown
                    const o2 = document.createElement('option');
                    o2.value = pkg.id;
                    o2.textContent = pkg.name;
                    filterSel.appendChild(o2);
                });
            });
    }

    // â”€â”€ Submit review â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function submitReview() {
        const packageId = document.getElementById('pkg-select').value;
        const reviewText = document.getElementById('review-text').value.trim();
        const ratingEl  = document.querySelector('.stars input:checked');
        const rating    = ratingEl ? parseInt(ratingEl.value) : null;

        if (!packageId)   { showMsg('âš ï¸ Please select a package.', 'error');   return; }
        if (!rating)      { showMsg('âš ï¸ Please select a star rating.', 'error'); return; }
        if (!reviewText)  { showMsg('âš ï¸ Please write your review.', 'error');  return; }

        const btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.textContent = 'Submitting...';
        showMsg('â³ Submitting your review...', 'loading');

        fetch(`${API}/reviews`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: currentUserId,
                packageId: parseInt(packageId),
                review: reviewText,
                rating: rating
            })
        })
        .then(r => r.json())
        .then(() => {
            showMsg('âœ… Review submitted! Thank you.', 'success');
            btn.disabled = false;
            btn.textContent = 'â­ Submit Review';
            // Reset form
            document.getElementById('pkg-select').value = '';
            document.getElementById('review-text').value = '';
            document.querySelectorAll('.stars input').forEach(i => i.checked = false);
            document.getElementById('rating-text').textContent = 'Click a star to rate';
            // Refresh list
            setTimeout(() => loadReviews(), 500);
        })
        .catch(() => {
            showMsg('âŒ Could not submit review. Is Spring Boot running?', 'error');
            btn.disabled = false;
            btn.textContent = 'â­ Submit Review';
        });
    }

    // â”€â”€ Load reviews â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function loadReviews() {
        const listEl    = document.getElementById('reviews-list');
        const filterPkg = document.getElementById('filter-pkg').value;

        listEl.innerHTML = `<div class="state-msg"><div class="icon">â³</div><p>Loading...</p></div>`;

        const url = filterPkg
            ? `${API}/reviews/package/${filterPkg}`
            : `${API}/reviews`;

        fetch(url)
            .then(r => r.json())
            .then(reviews => {
                allReviews = reviews;
                updateSummary(reviews);

                if (!reviews.length) {
                    listEl.innerHTML = `
                        <div class="state-msg">
                            <div class="icon">ğŸ“­</div>
                            <p>No reviews yet.<br>Be the first to review!</p>
                        </div>`;
                    return;
                }

                listEl.innerHTML = '';
                reviews.forEach(r => {
                    const pkg     = packages.find(p => p.id == r.packageId);
                    const pkgName = pkg ? pkg.name : `Package #${r.packageId}`;
                    const stars   = renderStars(r.rating);

                    const card = document.createElement('div');
                    card.className = 'review-card';
                    card.innerHTML = `
                        <div class="review-top">
                            <div>
                                <div class="review-pkg">ğŸ“¦ ${pkgName}</div>
                                <div class="review-user">ğŸ‘¤ User #${r.userId}</div>
                            </div>
                            <div class="star-display">${stars}</div>
                        </div>
                        <div class="review-text">${r.review}</div>
                        ${r.userId === currentUserId
                            ? `<button class="delete-btn" onclick="deleteReview(${r.id})">Delete</button>`
                            : ''}
                    `;
                    listEl.appendChild(card);
                });
            })
            .catch(() => {
                listEl.innerHTML = `
                    <div class="state-msg">
                        <div class="icon">âš ï¸</div>
                        <p>Could not load reviews.<br>Is Spring Boot running?</p>
                    </div>`;
            });
    }

    // â”€â”€ Render star display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderStars(rating) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            stars += i <= rating ? 'â˜…' : '<span class="empty">â˜…</span>';
        }
        return stars;
    }

    // â”€â”€ Summary bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateSummary(reviews) {
        const bar = document.getElementById('summary-bar');
        if (!reviews.length) { bar.style.display = 'none'; return; }

        bar.style.display = 'flex';
        const avg  = reviews.reduce((s, r) => s + r.rating, 0) / reviews.length;
        document.getElementById('sum-total').textContent = reviews.length;
        document.getElementById('sum-avg').textContent   = avg.toFixed(1);
        document.getElementById('sum-5').textContent     = reviews.filter(r => r.rating === 5).length;
        document.getElementById('sum-4').textContent     = reviews.filter(r => r.rating === 4).length;
        document.getElementById('sum-3').textContent     = reviews.filter(r => r.rating === 3).length;
    }

    // â”€â”€ Delete review â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function deleteReview(id) {
        if (!confirm('Delete this review?')) return;
        
fetch(`${API}/reviews/${id}?userId=${currentUserId}`, { method: 'DELETE' })
            .then(() => loadReviews())
            .catch(() => alert('Could not delete review.'));
    }

    // â”€â”€ Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showMsg(text, type) {
        const el = document.getElementById('review-msg');
        el.textContent = text;
        el.className = `message ${type}`;
    }

    function logout() {
        localStorage.removeItem('vv_user');
        window.location.href = 'login.html';
    }
</script>

</body>
</html>
